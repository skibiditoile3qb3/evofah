<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plinko Game</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif;}
body{background:linear-gradient(145deg,#0a0e27,#1a1a2e);color:white;min-height:100vh;display:flex;justify-content:center;align-items:center;padding:20px;}
.game-container{max-width:900px;width:100%;background:linear-gradient(145deg,#1a1a2e,#16213e);border-radius:20px;padding:40px;box-shadow:0 10px 50px rgba(0,0,0,0.5);}
.header{text-align:center;margin-bottom:30px;}
h1{font-size:48px;color:#00ff9d;text-shadow:0 0 20px rgba(0,255,157,0.5);margin-bottom:10px;}
.stats{display:flex;justify-content:space-around;margin-bottom:30px;padding:20px;background: rgba(0,0,0,0.6);border-radius:10px;}
.stat{text-align:center;}
.stat-label{font-size:14px;opacity:0.7;margin-bottom:5px;}
.stat-value{font-size:28px;font-weight:bold;color:#00ff9d;}
.controls{display:flex;gap:15px;margin-bottom:30px;flex-wrap:wrap;justify-content:center;align-items:flex-end;}
.control-group{display:flex;flex-direction:column;gap:8px;}
label{font-size:14px;color:#00ff9d;font-weight:bold;}
select,input{padding:12px 20px;background: rgba(0,0,0,0.5);border:2px solid #00ff9d;border-radius:8px;color:white;font-size:16px;outline:none;}
select:focus,input:focus{border-color:#00ffff;}
button{padding:15px 40px;background:#00ff9d;color:#000;border:none;border-radius:8px;font-size:18px;font-weight:bold;cursor:pointer;transition: all 0.3s;text-transform:uppercase;}
button:hover:not(:disabled){transform:translateY(-3px);box-shadow:0 5px 20px rgba(0,255,157,0.5);}
button:disabled{opacity:0.3;cursor:not-allowed;}
#plinkoCanvas{display:block;margin:0 auto;border:3px solid #00ff9d;border-radius:10px;background: linear-gradient(180deg,#0a0e27 0%,#16213e 100%);box-shadow:0 5px 30px rgba(0,255,157,0.2);max-width:100%;}
.multipliers{display:flex;justify-content:space-around;margin-top:20px;padding:15px;background: rgba(0,0,0,0.6);border-radius:10px;gap:3px;}
.multiplier{padding:10px 5px;border-radius:8px;font-weight:bold;font-size:13px;text-align:center;flex:1;box-shadow:0 2px 10px rgba(0,0,0,0.3);}
.mult-high{background:#8e24aa;color:white;}
.mult-medium-high{background:#3949ab;color:white;}
.mult-medium{background:#43a047;color:white;}
.mult-low{background:#fdd835;color:#000;}
.mult-very-low{background:#e53935;color:white;}
.history{margin-top:30px;padding:20px;background: rgba(0,0,0,0.6);border-radius:10px;max-height:200px;overflow-y:auto;}
.history-title{font-weight:bold;margin-bottom:15px;color:#00ff9d;font-size:18px;}
.history-item{padding:10px 15px;margin:8px 0;border-radius:8px;font-size:15px;display:flex;justify-content:space-between;transition:all 0.2s;}
.history-item:hover{transform:translateX(5px);}
.win{background: rgba(0,255,157,0.2);border-left:4px solid #00ff9d;}
.loss{background: rgba(255,69,87,0.2);border-left:4px solid #ff4557;}
.profit{font-weight:bold;}
.profit.positive{color:#00ff9d;}
.profit.negative{color:#ff4557;}
.history::-webkit-scrollbar{width:8px;}
.history::-webkit-scrollbar-track{background: rgba(0,0,0,0.3);border-radius:10px;}
.history::-webkit-scrollbar-thumb{background:#00ff9d;border-radius:10px;}
</style>
</head>
<body>
<div class="game-container">
<div class="header"><h1>ðŸŽ¯ PLINKO GAME</h1></div>
<div class="stats">
<div class="stat"><div class="stat-label">Balance</div><div class="stat-value">$<span id="balance">1000</span></div></div>
<div class="stat"><div class="stat-label">Current Bet</div><div class="stat-value">$<span id="currentBet">10</span></div></div>
<div class="stat"><div class="stat-label">Total Profit</div><div class="stat-value" id="totalProfit">$0</div></div>
</div>
<div class="controls">
<div class="control-group">
<label>Risk Level</label>
<select id="riskLevel">
<option value="low">Low Risk</option>
<option value="medium" selected>Medium Risk</option>
<option value="high">High Risk</option>
</select>
</div>
<div class="control-group">
<label>Bet Amount</label>
<input type="number" id="betAmount" value="10" min="1" max="1000" step="1">
</div>
<div class="control-group">
<label>Number of Balls</label>
<input type="number" id="numBalls" value="1" min="1" max="10" step="1">
</div>
<button id="dropBtn">Drop Ball(s)</button>
</div>
<canvas id="plinkoCanvas" width="650" height="600"></canvas>
<div class="multipliers" id="multiplierDisplay"></div>
<div class="history">
<div class="history-title">ðŸ“Š Recent Drops</div>
<div id="historyList"></div>
</div>
</div>
<script>
const canvas=document.getElementById('plinkoCanvas');
const ctx=canvas.getContext('2d');
let balance=1000,totalProfit=0,isDropping=false,activeBalls=[],animationId=null,pendingBalls=0;

// Request coins from parent on load
window.parent.postMessage({type:'getCoins'},'*');

// Fallback: if no response in 500ms, use default balance
let coinsReceived = false;
setTimeout(() => {
    if (!coinsReceived) {
        balance = 1000;
        updateDisplay();
    }
}, 500);

// Listen for coin updates from parent
window.addEventListener('message',(event)=>{
if(event.data.type==='coinsData'){
coinsReceived = true;
balance=event.data.coins;
updateDisplay();
}
});

const ROWS=11,PEG_RADIUS=4,BALL_RADIUS=10,GRAVITY=0.5,BOUNCE=0.7,FRICTION=0.98;
const multipliers = {
    low:    [6, 4, 3, 2, 1, 0.5, 0.2, 0.1, 0.1, 0.2, 0.5, 1, 2, 3, 4, 6],
    medium: [8, 5, 3, 2, 0.8, 0.3, 0.15, 0.1, 0.1, 0.15, 0.3, 0.8, 2, 3, 5, 8],
    high:   [12, 7, 5, 3, 1, 0.3, 0.1, 0.05, 0.05, 0.1, 0.3, 1, 3, 5, 7, 12]
};

let pegs=[],buckets=[];

function initializeBoard(){
pegs=[];
const startX=canvas.width/2,startY=80,hSpacing=50,vSpacing=38;
for(let row=0;row<ROWS;row++){
const pegsInRow=row+3,rowWidth=(pegsInRow-1)*hSpacing,rowStartX=startX-rowWidth/2;
for(let col=0;col<pegsInRow;col++){
pegs.push({x:rowStartX+col*hSpacing,y:startY+row*vSpacing});
}
}
buckets=[];
const bucketCount=16,bWidth=canvas.width/bucketCount,bY=startY+ROWS*vSpacing+50;
const mults=getCurrentMultipliers();
for(let i=0;i<bucketCount;i++){
buckets.push({x:bWidth*i+bWidth/2,y:bY,width:bWidth*0.9,height:50,multiplier:mults[i]});
}
updateMultiplierDisplay();
drawBoard();
}

function getCurrentMultipliers(){return multipliers[document.getElementById('riskLevel').value];}

function updateMultiplierDisplay(){
const display=document.getElementById('multiplierDisplay');
const mults=getCurrentMultipliers();
display.innerHTML=mults.map(m=>{
let className='mult-medium';
if(m>=20)className='mult-high';
else if(m>=10)className='mult-medium-high';
else if(m>=5)className='mult-medium';
else if(m>=0.1)className='mult-low';
else className='mult-very-low';
return`<div class="multiplier ${className}">${m}x</div>`;
}).join('');
}

function drawBoard(){
ctx.clearRect(0,0,canvas.width,canvas.height);
pegs.forEach(peg=>{
ctx.shadowBlur=10;
ctx.shadowColor='rgba(0,255,157,0.5)';
ctx.beginPath();
ctx.arc(peg.x,peg.y,PEG_RADIUS,0,2*Math.PI);
ctx.fillStyle='#00ff9d';
ctx.fill();
ctx.shadowBlur=0;
});
buckets.forEach(bucket=>{
ctx.fillStyle=getBucketColor(bucket.multiplier);
ctx.fillRect(bucket.x-bucket.width/2,bucket.y,bucket.width,bucket.height);
ctx.strokeStyle='#00ff9d';
ctx.lineWidth=2;
ctx.strokeRect(bucket.x-bucket.width/2,bucket.y,bucket.width,bucket.height);
ctx.fillStyle='white';
ctx.font='bold 11px Arial';
ctx.textAlign='center';
ctx.textBaseline='middle';
ctx.fillText(bucket.multiplier+'x',bucket.x,bucket.y+bucket.height/2);
});
}

function getBucketColor(m){
if(m>=20)return'#8e24aa';
if(m>=10)return'#3949ab';
if(m>=5)return'#43a047';
if(m>=0.1)return'#fdd835';
return'#e53935';
}

class Ball{
constructor(x,y,betAmount){
this.x=x;
this.y=y;
this.vx=(Math.random()-0.5)*3;
this.vy=0;
this.radius=BALL_RADIUS;
this.landed=false;
this.landedBucket=null;
this.betAmount=betAmount;
// Random color for each ball
const hue = Math.random() * 360;
this.color = `hsl(${hue}, 80%, 60%)`;
this.shadowColor = `hsla(${hue}, 80%, 60%, 0.8)`;
}

update(){
if(this.landed)return;
this.vy+=GRAVITY;
this.vx*=FRICTION;
this.vy*=FRICTION;
this.x+=this.vx;
this.y+=this.vy;

// Peg collisions with improved physics
pegs.forEach(peg=>{
const dx=this.x-peg.x;
const dy=this.y-peg.y;
const dist=Math.sqrt(dx*dx+dy*dy);
const minDist=this.radius+PEG_RADIUS;

if(dist<minDist){
// Calculate collision angle
const angle=Math.atan2(dy,dx);
const overlap=minDist-dist;
  
// Push ball out of peg
this.x=peg.x+Math.cos(angle)*minDist;
this.y=peg.y+Math.sin(angle)*minDist;

// Calculate normal vector
const nx=dx/dist;
const ny=dy/dist;

// Calculate relative velocity
const dvx=this.vx;
const dvy=this.vy;

// Calculate velocity along normal
const dvn=dvx*nx+dvy*ny;

// Only bounce if moving toward peg
if(dvn<0){
// Reflect velocity with bounce factor
this.vx=(this.vx-2*dvn*nx)*BOUNCE;
this.vy=(this.vy-2*dvn*ny)*BOUNCE;

// Add random horizontal impulse for variety
this.vx+=(Math.random()-0.5)*2;
}
}
});

// Check buckets
buckets.forEach((bucket,i)=>{
if(this.y+this.radius>=bucket.y&&
this.x>bucket.x-bucket.width/2&&
this.x<bucket.x+bucket.width/2){
if(!this.landed){
this.landed=true;
this.landedBucket=i;
this.y=bucket.y-this.radius;
this.vx=0;
this.vy=0;
}
}
});

// Wall collisions
if(this.x-this.radius<0){
this.x=this.radius;
this.vx=Math.abs(this.vx)*BOUNCE;
}
if(this.x+this.radius>canvas.width){
this.x=canvas.width-this.radius;
this.vx=-Math.abs(this.vx)*BOUNCE;
}
}

draw(){
ctx.shadowBlur=15;
ctx.shadowColor=this.shadowColor;
ctx.beginPath();
ctx.arc(this.x,this.y,this.radius,0,2*Math.PI);
ctx.fillStyle=this.color;
ctx.fill();
ctx.shadowBlur=0;
ctx.strokeStyle='rgba(255,255,255,0.3)';
ctx.lineWidth=2;
ctx.stroke();
}
}

function dropBall(){
const betAmount=parseInt(document.getElementById('betAmount').value);
const numBalls=parseInt(document.getElementById('numBalls').value);
if(isNaN(betAmount)||betAmount<1){alert('Enter valid bet!');return;}
if(isNaN(numBalls)||numBalls<1||numBalls>100){alert('Enter 1-100 balls!');return;}
const totalBet=betAmount*numBalls;
if(totalBet>balance){alert('Insufficient balance!');return;}

balance-=totalBet;
updateDisplay();

isDropping=true;
pendingBalls=numBalls;
document.getElementById('dropBtn').disabled=true;

// Drop balls with slight delay between each
for(let i=0;i<numBalls;i++){
setTimeout(()=>{
const offsetX = (Math.random() - 0.5) * 20; // Slight random horizontal offset
const ball=new Ball(canvas.width/2 + offsetX,40,betAmount);
activeBalls.push(ball);

const checkLanded=setInterval(()=>{
if(ball.landed){
clearInterval(checkLanded);
const mult=buckets[ball.landedBucket].multiplier;
const win=Math.round(betAmount*mult);
balance+=win;
totalProfit+=win-betAmount;
updateDisplay();

// Update parent window coins
window.parent.postMessage({type:'updateCoins',coins:balance},'*');

addHistory(betAmount,mult,win,win-betAmount);

setTimeout(()=>{
activeBalls=activeBalls.filter(b=>b!==ball);
pendingBalls--;
if(pendingBalls===0 && activeBalls.length===0){
isDropping=false;
document.getElementById('dropBtn').disabled=false;
}
},500);
}
},50);
}, i * 200); // 200ms delay between each ball
}

if(!animationId)animate();
}

function animate(){
drawBoard();
activeBalls.forEach(ball=>{ball.update();ball.draw();});
if(activeBalls.length>0 || pendingBalls>0){
animationId=requestAnimationFrame(animate);
}else{
animationId=null;
}
}

function addHistory(bet,mult,win,profit){
const historyList=document.getElementById('historyList');
const item=document.createElement('div');
item.className='history-item '+(profit>=0?'win':'loss');
const profitSign=profit>=0?'+':'';
item.innerHTML=`<span>Bet: $${bet} Ã— ${mult}x = $${win}</span><span class="profit ${profit>=0?'positive':'negative'}">${profitSign}$${profit}</span>`;
historyList.insertBefore(item,historyList.firstChild);
while(historyList.children.length>15){
historyList.removeChild(historyList.lastChild);
}
}

function updateDisplay(){
document.getElementById('balance').textContent=balance;
document.getElementById('currentBet').textContent=document.getElementById('betAmount').value;
const profitEl=document.getElementById('totalProfit');
const profitSign=totalProfit>=0?'+':'';
profitEl.textContent=profitSign+'$'+totalProfit;
profitEl.style.color=totalProfit>=0?'#43e97b':'#f5576c';
}

document.getElementById('dropBtn').addEventListener('click',dropBall);
document.getElementById('betAmount').addEventListener('input',updateDisplay);
document.getElementById('riskLevel').addEventListener('change',()=>{initializeBoard();});

initializeBoard();
updateDisplay();
</script>
</body>
</html>
