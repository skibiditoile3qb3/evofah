<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plinko</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background: linear-gradient(145deg, #0a0e27, #1a1a2e);
            color: white;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            max-width: 900px;
            width: 100%;
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 48px;
            color: #00ff9d;
            text-shadow: 0 0 20px rgba(0, 255, 157, 0.5);
            margin-bottom: 10px;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
        }

        .stat {
            text-align: center;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.7;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #00ff9d;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-size: 14px;
            color: #00ff9d;
            font-weight: bold;
        }

        select, input {
            padding: 12px 20px;
            background: rgba(0,0,0,0.5);
            border: 2px solid #00ff9d;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            outline: none;
        }

        select:focus, input:focus {
            border-color: #00ffff;
        }

        button {
            padding: 15px 40px;
            background: #00ff9d;
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        button:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0, 255, 157, 0.5);
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        #plinkoCanvas {
            display: block;
            margin: 0 auto;
            border: 3px solid #00ff9d;
            border-radius: 10px;
            background: linear-gradient(180deg, #0a0e27 0%, #16213e 100%);
            box-shadow: 0 5px 30px rgba(0, 255, 157, 0.2);
        }

        .multipliers {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
        }

        .multiplier {
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            min-width: 60px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .mult-0-2 { background: #e53935; color: white; }
        .mult-0-5 { background: #fb8c00; color: white; }
        .mult-1 { background: #fdd835; color: #000; }
        .mult-2 { background: #43a047; color: white; }
        .mult-3 { background: #00897b; color: white; }
        .mult-5 { background: #3949ab; color: white; }
        .mult-10 { background: #8e24aa; color: white; }

        .history {
            margin-top: 30px;
            padding: 20px;
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .history-title {
            font-weight: bold;
            margin-bottom: 15px;
            color: #00ff9d;
            font-size: 18px;
        }

        .history-item {
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 15px;
            display: flex;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .history-item:hover {
            transform: translateX(5px);
        }

        .win {
            background: rgba(0, 255, 157, 0.2);
            border-left: 4px solid #00ff9d;
        }

        .loss {
            background: rgba(255, 69, 87, 0.2);
            border-left: 4px solid #ff4557;
        }

        .profit {
            font-weight: bold;
        }

        .profit.positive {
            color: #00ff9d;
        }

        .profit.negative {
            color: #ff4557;
        }

        /* Custom scrollbar */
        .history::-webkit-scrollbar {
            width: 8px;
        }

        .history::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
        }

        .history::-webkit-scrollbar-thumb {
            background: #00ff9d;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>ðŸŽ¯ PLINKO</h1>
        </div>

        <div class="stats">
            <div class="stat">
                <div class="stat-label">Balance</div>
                <div class="stat-value">$<span id="balance">0</span></div>
            </div>
            <div class="stat">
                <div class="stat-label">Current Bet</div>
                <div class="stat-value">$<span id="currentBet">10</span></div>
            </div>
            <div class="stat">
                <div class="stat-label">Total Profit</div>
                <div class="stat-value" id="totalProfit">$0</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>Risk Level</label>
                <select id="riskLevel">
                    <option value="low">Low Risk</option>
                    <option value="medium" selected>Medium Risk</option>
                    <option value="high">High Risk</option>
                </select>
            </div>
            <div class="control-group">
                <label>Bet Amount</label>
                <input type="number" id="betAmount" value="10" min="1" step="1">
            </div>
            <button id="dropBtn" onclick="dropBall()">Drop Ball</button>
        </div>

        <canvas id="plinkoCanvas" width="700" height="600"></canvas>
        
        <div class="multipliers" id="multiplierDisplay"></div>

        <div class="history">
            <div class="history-title">Recent Drops</div>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('plinkoCanvas');
        const ctx = canvas.getContext('2d');

        let balance = 0;
        let totalProfit = 0;
        let isDropping = false;
        let activeBalls = [];
        let animationId = null;
        let coinsLoaded = false;

        const ROWS = 12;
        const PEG_RADIUS = 5;
        const BALL_RADIUS = 8;
        const GRAVITY = 0.3;
        const BOUNCE = 0.6;
        const FRICTION = 0.99;

        const multipliers = {
            low: [0.5, 1, 1, 1, 2, 2, 2, 1, 1, 1, 0.5],
            medium: [0.5, 1, 1, 2, 2, 3, 2, 2, 1, 1, 0.5],
            high: [0.2, 0.5, 1, 2, 3, 5, 3, 2, 1, 0.5, 0.2]
        };

        let pegs = [];
        let buckets = [];

        // Request coins from parent
        window.parent.postMessage({ type: 'getCoins' }, '*');

        window.addEventListener('message', (event) => {
            if (event.data.type === 'coinsData') {
                balance = event.data.coins;
                coinsLoaded = true;
                updateDisplay();
            }
        });

        function updateParentCoins() {
            window.parent.postMessage({
                type: 'updateCoins',
                coins: balance
            }, '*');
        }

        function initializeBoard() {
            pegs = [];
            const startX = canvas.width / 2;
            const startY = 80;
            const horizontalSpacing = 50;
            const verticalSpacing = 40;

            for (let row = 0; row < ROWS; row++) {
                const pegsInRow = row + 3;
                const rowWidth = (pegsInRow - 1) * horizontalSpacing;
                const rowStartX = startX - rowWidth / 2;

                for (let col = 0; col < pegsInRow; col++) {
                    pegs.push({
                        x: rowStartX + col * horizontalSpacing,
                        y: startY + row * verticalSpacing
                    });
                }
            }

            // Initialize buckets
            buckets = [];
            const bucketCount = ROWS + 3;
            const bucketWidth = canvas.width / (bucketCount + 1);
            const bucketY = startY + ROWS * verticalSpacing + 30;

            for (let i = 0; i < bucketCount; i++) {
                buckets.push({
                    x: bucketWidth * (i + 0.5),
                    y: bucketY,
                    width: bucketWidth * 0.9,
                    height: 40,
                    multiplier: getCurrentMultipliers()[i]
                });
            }
        }

        function getCurrentMultipliers() {
            const risk = document.getElementById('riskLevel').value;
            return multipliers[risk];
        }

        function updateMultiplierDisplay() {
            const display = document.getElementById('multiplierDisplay');
            const mults = getCurrentMultipliers();
            display.innerHTML = mults.map(m => {
                let className = 'mult-1';
                if (m === 0.2) className = 'mult-0-2';
                else if (m === 0.5) className = 'mult-0-5';
                else if (m === 2) className = 'mult-2';
                else if (m === 3) className = 'mult-3';
                else if (m === 5) className = 'mult-5';
                else if (m === 10) className = 'mult-10';
                return `<div class="multiplier ${className}">${m}x</div>`;
            }).join('');
        }

        function drawBoard() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw pegs with glow
            pegs.forEach(peg => {
                ctx.shadowBlur = 10;
                ctx.shadowColor = 'rgba(0, 255, 157, 0.5)';
                ctx.beginPath();
                ctx.arc(peg.x, peg.y, PEG_RADIUS, 0, Math.PI * 2);
                ctx.fillStyle = '#00ff9d';
                ctx.fill();
                ctx.shadowBlur = 0;
            });

            // Draw buckets
            buckets.forEach(bucket => {
                ctx.fillStyle = getBucketColor(bucket.multiplier);
                ctx.fillRect(bucket.x - bucket.width / 2, bucket.y, bucket.width, bucket.height);
                
                ctx.strokeStyle = '#00ff9d';
                ctx.lineWidth = 2;
                ctx.strokeRect(bucket.x - bucket.width / 2, bucket.y, bucket.width, bucket.height);

                ctx.fillStyle = 'white';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(bucket.multiplier + 'x', bucket.x, bucket.y + 26);
            });
        }

        function getBucketColor(mult) {
            if (mult >= 5) return '#8e24aa';
            if (mult >= 3) return '#3949ab';
            if (mult >= 2) return '#43a047';
            if (mult >= 1) return '#fdd835';
            if (mult >= 0.5) return '#fb8c00';
            return '#e53935';
        }

        class Ball {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.vx = (Math.random() - 0.5) * 2;
                this.vy = 0;
                this.radius = BALL_RADIUS;
                this.landed = false;
                this.landedBucket = null;
            }

            update() {
                if (this.landed) return;

                // Apply gravity
                this.vy += GRAVITY;

                // Apply friction
                this.vx *= FRICTION;
                this.vy *= FRICTION;

                // Update position
                this.x += this.vx;
                this.y += this.vy;

                // Check collision with pegs
                pegs.forEach(peg => {
                    const dx = this.x - peg.x;
                    const dy = this.y - peg.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < this.radius + PEG_RADIUS) {
                        const angle = Math.atan2(dy, dx);
                        const targetX = peg.x + Math.cos(angle) * (PEG_RADIUS + this.radius);
                        const targetY = peg.y + Math.sin(angle) * (PEG_RADIUS + this.radius);

                        this.x = targetX;
                        this.y = targetY;

                        const ax = (this.vx * Math.cos(angle) + this.vy * Math.sin(angle)) * Math.cos(angle);
                        const ay = (this.vx * Math.cos(angle) + this.vy * Math.sin(angle)) * Math.sin(angle);

                        this.vx = (this.vx - 2 * ax) * BOUNCE;
                        this.vy = (this.vy - 2 * ay) * BOUNCE;

                        // Add some randomness
                        this.vx += (Math.random() - 0.5) * 0.5;
                    }
                });

                // Check if landed in bucket
                buckets.forEach((bucket, index) => {
                    if (this.y > bucket.y && 
                        this.x > bucket.x - bucket.width / 2 && 
                        this.x < bucket.x + bucket.width / 2) {
                        if (!this.landed) {
                            this.landed = true;
                            this.landedBucket = index;
                            this.y = bucket.y;
                            this.vy = 0;
                            this.vx = 0;
                        }
                    }
                });

                // Walls
                if (this.x < this.radius) {
                    this.x = this.radius;
                    this.vx *= -BOUNCE;
                }
                if (this.x > canvas.width - this.radius) {
                    this.x = canvas.width - this.radius;
                    this.vx *= -BOUNCE;
                }
            }

            draw() {
                ctx.shadowBlur = 15;
                ctx.shadowColor = 'rgba(255, 107, 107, 0.8)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = '#ff6b6b';
                ctx.fill();
                ctx.shadowBlur = 0;
                
                ctx.strokeStyle = '#ff4757';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }

        function dropBall() {
            if (!coinsLoaded) {
                alert('Loading your coin balance... Please wait a moment and try again.');
                return;
            }

            const betAmount = parseInt(document.getElementById('betAmount').value);
            
            if (betAmount > balance) {
                alert('Not enough coins! You have $' + balance);
                return;
            }

            if (betAmount < 1) {
                alert('Bet must be at least $1!');
                return;
            }

            if (isDropping) return;

            balance -= betAmount;
            updateParentCoins();
            updateDisplay();

            const ball = new Ball(canvas.width / 2, 40);
            activeBalls.push(ball);

            isDropping = true;
            document.getElementById('dropBtn').disabled = true;

            if (!animationId) {
                animate();
            }

            // Check when ball lands
            const checkLanded = setInterval(() => {
                if (ball.landed) {
                    clearInterval(checkLanded);
                    const multiplier = buckets[ball.landedBucket].multiplier;
                    const winAmount = Math.floor(betAmount * multiplier);
                    balance += winAmount;
                    updateParentCoins();
                    
                    const profit = winAmount - betAmount;
                    totalProfit += profit;
                    
                    updateDisplay();
                    addHistory(betAmount, multiplier, winAmount, profit);

                    setTimeout(() => {
                        activeBalls = activeBalls.filter(b => b !== ball);
                        if (activeBalls.length === 0) {
                            isDropping = false;
                            document.getElementById('dropBtn').disabled = false;
                        }
                    }, 1000);
                }
            }, 100);
        }

        function animate() {
            drawBoard();

            activeBalls.forEach(ball => {
                ball.update();
                ball.draw();
            });

            if (activeBalls.length > 0) {
                animationId = requestAnimationFrame(animate);
            } else {
                animationId = null;
            }
        }

        function addHistory(bet, mult, win, profit) {
            const historyList = document.getElementById('historyList');
            const item = document.createElement('div');
            item.className = 'history-item ' + (profit >= 0 ? 'win' : 'loss');
            
            const profitClass = profit >= 0 ? 'positive' : 'negative';
            item.innerHTML = `
                <span>Bet: $${bet} Ã— ${mult}x</span>
                <span class="profit ${profitClass}">${profit >= 0 ? '+' : ''}$${profit}</span>
            `;
            
            historyList.insertBefore(item, historyList.firstChild);

            // Keep only last 10
            while (historyList.children.length > 10) {
                historyList.removeChild(historyList.lastChild);
            }
        }

        function updateDisplay() {
            document.getElementById('balance').textContent = balance;
            document.getElementById('currentBet').textContent = document.getElementById('betAmount').value;
            
            const profitEl = document.getElementById('totalProfit');
            profitEl.textContent = (totalProfit >= 0 ? '+$' : '-$') + Math.abs(totalProfit);
            profitEl.style.color = totalProfit >= 0 ? '#00ff9d' : '#ff4557';
        }

        // Update bet display on input
        document.getElementById('betAmount').addEventListener('input', updateDisplay);
        document.getElementById('riskLevel').addEventListener('change', () => {
            initializeBoard();
            updateMultiplierDisplay();
            drawBoard();
        });

        // Initialize
        initializeBoard();
        updateMultiplierDisplay();
        drawBoard();
        updateDisplay();
    </script>
</body>
</html>
